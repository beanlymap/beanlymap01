// api/ratings.js
// Mic backend in-memory pentru Vercel.
// ATENȚIE: datele se pot pierde la redeploy sau schimbarea instanței.
// Pentru producție serios, va trebui conectat la o bază de date.

let ratingsStore = {}; // { cafeId: { total, votes }, ... }

module.exports = (req, res) => {
  // CORS basic (nu e neapărat necesar pentru același origin, dar nu strică)
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    res.statusCode = 200;
    res.end();
    return;
  }

  if (req.method === "GET") {
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify(ratingsStore));
    return;
  }

  if (req.method === "POST") {
    let body = "";
    req.on("data", chunk => {
      body += chunk;
    });
    req.on("end", () => {
      try {
        const data = JSON.parse(body);
        const cafeId = data.cafeId;
        const rating = Number(data.rating);

        if (
          !cafeId ||
          typeof cafeId !== "string" ||
          isNaN(rating) ||
          rating < 1 ||
          rating > 5
        ) {
          res.statusCode = 400;
          res.end("Invalid payload");
          return;
        }

        if (!ratingsStore[cafeId]) {
          ratingsStore[cafeId] = { total: 0, votes: 0 };
        }
        ratingsStore[cafeId].total += rating;
        ratingsStore[cafeId].votes += 1;

        res.setHeader("Content-Type", "application/json");
        res.end(JSON.stringify(ratingsStore[cafeId]));
      } catch (err) {
        res.statusCode = 400;
        res.end("Invalid JSON");
      }
    });
    return;
  }

  res.statusCode = 405;
  res.end("Method not allowed");
};
