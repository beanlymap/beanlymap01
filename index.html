<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Beanly Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* Leaderboard mic */
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 900;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 170px;
      font-size: 11px;
      line-height: 1.3;
    }

    #leaderboard h4 {
      margin: 0 0 4px;
      font-size: 12px;
    }

    #leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #leaderboard li {
      margin-bottom: 4px;
      cursor: pointer;
    }

    #leaderboard li span.name {
      font-weight: 600;
    }

    #leaderboard li span.stats {
      color: #555;
      font-size: 11px;
    }

    /* ascundem butoanele + / - ale hƒÉr»õii */
    .leaflet-control-zoom {
      display: none;
    }

    /* Modal rating */
    #rating-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1100;
      justify-content: center;
      align-items: center;
    }

    #rating-modal {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 280px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    #rating-modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    #rating-modal p {
      margin: 4px 0 10px;
      font-size: 14px;
    }

    /* Stele */
    #rating-stars {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
      justify-content: center;
    }

    .star {
      font-size: 24px;
      color: #cccccc;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease, color 0.1s ease;
    }

    .star.active {
      color: #f5b301;
      transform: scale(1.05);
    }

    #rating-emoji {
      text-align: center;
      font-size: 22px;
      margin-bottom: 10px;
      min-height: 26px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    button {
      cursor: pointer;
    }

    .btn-primary {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #000;
      color: #fff;
      font-size: 14px;
    }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 6px;
      background: #f5f5f5;
      border: 1px solid #aaa;
      font-size: 14px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }

    .popup button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #000;
      color: #fff;
      font-size: 13px;
    }

    .popup button[disabled] {
      opacity: 0.5;
      cursor: default;
      background: #444;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="leaderboard"></div>

<!-- Modal rating -->
<div id="rating-modal-backdrop">
  <div id="rating-modal">
    <h3 id="rating-title">LasƒÉ un rating</h3>
    <p id="rating-subtitle"></p>

    <div id="rating-stars">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
    </div>

    <div id="rating-emoji"></div>

    <div class="modal-actions">
      <button id="rating-cancel" class="btn-secondary">AnuleazƒÉ</button>
      <button id="rating-submit" class="btn-primary">Trimite</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // =======================
  // CONFIG SUPABASE
  // =======================
  const SUPABASE_URL = "https://fmjzvkjirengslympwyy.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Huzv6C0t7gw4UFgb_7Za0A_Ptj6hwu_";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  // MapTiler 
const MAPTILER_KEY = "K2TXKYl91HXvMVDhjRcy "; 

  // =======================
  // Date cafenele reale
  // =======================
  const cafes = [
    { id: "coffee_drive",        name: "COFFEE DRIVE",        coords: [47.060133, 28.874532] },
    { id: "coffee_stop",         name: "Coffee Stop",         coords: [47.066017, 28.856687] },
    { id: "black_coffee_drive",  name: "Black Coffee Drive",  coords: [47.046993, 28.779928] },
    { id: "flamingo_coffee",     name: "Flamingo Coffee",     coords: [47.061938, 28.848433] },
    { id: "grand_coffee_place",  name: "Grand Coffee Place",  coords: [47.001321, 28.871157] }
  ];

  const ratingEmojis = {
    1: "üò£",
    2: "üòï",
    3: "üòê",
    4: "üôÇ",
    5: "ü§©"
  };

  // hartƒÉ + markere
  let map = null;
  const markers = {};

  // =======================
  // Device ID
  // =======================
  function getOrCreateDeviceId() {
    let id = localStorage.getItem("beanly_device_id");
    if (!id) {
      id = "dev_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem("beanly_device_id", id);
    }
    return id;
  }
  const DEVICE_ID = getOrCreateDeviceId();

  // =======================
  // Ratinguri user local
  // =======================
  function getUserRatingsMap() {
    const raw = localStorage.getItem("beanly_user_ratings");
    if (!raw) return {};
    try {
      return JSON.parse(raw);
    } catch {
      return {};
    }
  }

  function setUserRatingsMap(mapObj) {
    localStorage.setItem("beanly_user_ratings", JSON.stringify(mapObj));
  }

  function getUserRating(cafeId) {
    const mapObj = getUserRatingsMap();
    return typeof mapObj[cafeId] === "number" ? mapObj[cafeId] : null;
  }

  function hasUserRated(cafeId) {
    return getUserRating(cafeId) !== null;
  }

  function registerUserRatingLocal(cafeId, rating) {
    const mapObj = getUserRatingsMap();
    mapObj[cafeId] = rating;
    setUserRatingsMap(mapObj);
  }

  // =======================
  // Ratinguri globale din Supabase
  // =======================
  let globalRatings = {}; // { cafeId: { avg, votes } }
  const leaderboardEl = document.getElementById("leaderboard");

  function buildLeaderboard() {
    if (!leaderboardEl) return;

    const items = cafes.map(cafe => {
      const info = globalRatings[cafe.id];
      return { id: cafe.id, name: cafe.name, info };
    });

    const rated = items.filter(it => it.info && it.info.votes > 0);

    if (!rated.length) {
      leaderboardEl.innerHTML = `
        <h4>Top ‚òï</h4>
        <div style="font-size:11px;color:#555;">√éncƒÉ nu sunt ratinguri. Fii primul care voteazƒÉ!</div>
      `;
      return;
    }

    rated.sort((a, b) => b.info.avg - a.info.avg);
    const top = rated.slice(0, 5);

    let html = `<h4>Top ‚òï</h4><ul>`;
    top.forEach(it => {
      const avg = it.info.avg.toFixed(1);
      const votes = it.info.votes;
      html += `
        <li data-id="${it.id}">
          <span class="name">${it.name}</span><br>
          <span class="stats">${avg} ‚≠ê ¬∑ (${votes})</span>
        </li>
      `;
    });
    html += `</ul>`;

    leaderboardEl.innerHTML = html;

    const lis = leaderboardEl.querySelectorAll("li[data-id]");
    lis.forEach(li => {
      li.addEventListener("click", () => {
        const id = li.getAttribute("data-id");
        const cafe = cafes.find(c => c.id === id);
        if (!cafe || !map) return;
        map.setView(cafe.coords, 15);
        const marker = markers[id];
        if (marker) {
          marker.openPopup();
        }
      });
    });
  }

  async function loadGlobalRatings() {
    try {
      const { data, error } = await sb
        .from("ratings")
        .select("cafe_id, rating");

      if (error) {
        console.warn("Supabase select error:", error.message);
        return;
      }

      const agg = {};
      (data || []).forEach(row => {
        const id = row.cafe_id;
        const r = row.rating;
        if (!agg[id]) {
          agg[id] = { sum: 0, count: 0 };
        }
        agg[id].sum += r;
        agg[id].count += 1;
      });

      const result = {};
      Object.keys(agg).forEach(id => {
        const { sum, count } = agg[id];
        result[id] = {
          avg: sum / count,
          votes: count
        };
      });

      globalRatings = result;
      buildLeaderboard();
    } catch (e) {
      console.warn("Eroare la loadGlobalRatings:", e);
    }
  }

  function getAverageText(cafeId) {
    const info = globalRatings[cafeId];
    if (!info || !info.votes) return "Nu are rating";
    const avg = Number(info.avg).toFixed(1);
    return `${avg} ‚≠ê (${info.votes} voturi)`;
  }

  async function sendRatingToServer(cafeId, rating) {
    const payload = {
      cafe_id: cafeId,
      device_id: DEVICE_ID,
      rating: rating,
    };

    const { error } = await sb
      .from("ratings")
      .insert(payload);

    if (error) {
      if (error.message && error.message.includes("unique_cafe_device")) {
        throw new Error("already-rated");
      }
      throw new Error("server-error: " + error.message);
    }
  }

  // =======================
  // Modal rating
  // =======================
  let currentCafeId = null;
  let currentCafeName = null;
  let currentRating = null;

  const modalBackdrop  = document.getElementById("rating-modal-backdrop");
  const ratingTitle    = document.getElementById("rating-title");
  const ratingSubtitle = document.getElementById("rating-subtitle");
  const btnCancel      = document.getElementById("rating-cancel");
  const btnSubmit      = document.getElementById("rating-submit");
  const starElems      = document.querySelectorAll("#rating-stars .star");
  const emojiElem      = document.getElementById("rating-emoji");

  function resetStars() {
    currentRating = null;
    starElems.forEach(s => s.classList.remove("active"));
    emojiElem.textContent = "";
  }

  function updateEmoji() {
    if (!currentRating) {
      emojiElem.textContent = "";
      return;
    }
    emojiElem.textContent = ratingEmojis[currentRating] || "";
  }

  function openRatingModal(cafeId, cafeName) {
    if (hasUserRated(cafeId)) {
      const r = getUserRating(cafeId);
      alert(`Ai votat deja ${cafeName} cu ${r} ‚≠ê de pe acest telefon.`);
      return;
    }

    currentCafeId = cafeId;
    currentCafeName = cafeName;
    ratingTitle.textContent = "LasƒÉ un rating";
    ratingSubtitle.textContent = cafeName;
    resetStars();
    modalBackdrop.style.display = "flex";
  }

  function closeRatingModal() {
    modalBackdrop.style.display = "none";
    currentCafeId = null;
    currentCafeName = null;
    currentRating = null;
  }

  starElems.forEach(star => {
    star.addEventListener("click", () => {
      const val = parseInt(star.getAttribute("data-value"), 10);
      currentRating = val;
      starElems.forEach(s => {
        const sVal = parseInt(s.getAttribute("data-value"), 10);
        s.classList.toggle("active", sVal <= val);
      });
      updateEmoji();
    });
  });

  btnCancel.addEventListener("click", closeRatingModal);

  btnSubmit.addEventListener("click", async () => {
    if (!currentCafeId) return;

    if (!currentRating || currentRating < 1 || currentRating > 5) {
      alert("Alege un numƒÉr de stele (1‚Äì5).");
      return;
    }

    try {
      await sendRatingToServer(currentCafeId, currentRating);
      registerUserRatingLocal(currentCafeId, currentRating);

      alert(`‚úÖ Mul»õumim! Ai dat ${currentRating} stele pentru ${currentCafeName}.`);

      await loadGlobalRatings();
      closeRatingModal();
      location.reload();
    } catch (e) {
      if (e.message === "already-rated") {
        const existing = getUserRating(currentCafeId);
        if (existing) {
          alert(`Ai votat deja ${currentCafeName} cu ${existing} ‚≠ê de pe acest telefon.`);
        } else {
          alert(`Ai votat deja ${currentCafeName} de pe acest device.`);
        }
      } else {
        console.error(e);
        alert("Eroare la server: " + (e.message || "necunoscutƒÉ"));
      }
      closeRatingModal();
    }
  });

  // =======================
  // Init
  // =======================
  document.addEventListener("DOMContentLoaded", async function() {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      tg.MainButton.hide();
    }

    await loadGlobalRatings();

        map = L.map('map').setView([47.040, 28.85], 12.5);

    L.tileLayer(
      `https://api.maptiler.com/maps/navigation-day/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ' +
          'contributors & <a href="https://www.maptiler.com/">MapTiler</a>'
      }
    ).addTo(map);



    cafes.forEach(cafe => {
      const avgText = getAverageText(cafe.id);
      const userRating = getUserRating(cafe.id);
      const buttonLabel = userRating ? `Ai votat: ${userRating} ‚≠ê` : "LasƒÉ un rating";
      const buttonDisabled = userRating ? 'disabled="disabled"' : "";

      const marker = L.marker(cafe.coords).addTo(map)
        .bindPopup(`
          <div class="popup">
            <b>${cafe.name}</b><br>
            Rating: ${avgText}<br><br>
            <button class="rate-btn" data-id="${cafe.id}" data-name="${cafe.name}" ${buttonDisabled}>
              ${buttonLabel}
            </button>
          </div>
        `);

      markers[cafe.id] = marker;

      marker.on('popupopen', (e) => {
        const btn = e.popup._contentNode.querySelector('.rate-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute("data-id");
            const name = btn.getAttribute("data-name");
            openRatingModal(id, name);
          });
        }
      });
    });
  });
</script>

</body>
</html>
