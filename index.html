<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Beanly Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* Leaderboard mic */
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 900;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 170px;
      font-size: 11px;
      line-height: 1.3;
    }

    #leaderboard h4 {
      margin: 0 0 4px;
      font-size: 12px;
    }

    #leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #leaderboard li {
      margin-bottom: 4px;
      cursor: pointer;
    }

    #leaderboard li span.name {
      font-weight: 600;
    }

    #leaderboard li span.stats {
      color: #555;
      font-size: 11px;
    }

    /* Hide zoom buttons */
    .leaflet-control-zoom {
      display: none;
    }

    /* Modal rating */
    #rating-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    #rating-modal {
      width: 280px;
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    .star {
      font-size: 26px;
      cursor: pointer;
      color: #bbb;
    }

    .star.active {
      color: #f5b301;
    }
  </style>
</head>

<body>

<div id="map"></div>
<div id="leaderboard"></div>

<!-- Rating modal -->
<div id="rating-modal-backdrop">
  <div id="rating-modal">
    <h3>Lasă un rating</h3>
    <p id="rating-cafe-name"></p>

    <div id="rating-stars">
      <span class="star" data-val="1">★</span>
      <span class="star" data-val="2">★</span>
      <span class="star" data-val="3">★</span>
      <span class="star" data-val="4">★</span>
      <span class="star" data-val="5">★</span>
    </div>

    <div style="padding-top: 10px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="cancelBtn">Anulează</button>
      <button id="sendBtn">Trimite</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------------------
   CONFIG
---------------------------- */

const MAPTILER_KEY = "K2TXKYl91HXvMVDhjRcy";

const SUPABASE_URL = "https://fmjzvkjirengslympwyy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Huzv6C0t7gw4UFgb_7Za0A_Ptj6hwu_";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------------------
   CAFENELE
---------------------------- */

const cafes = [
  { id: "coffee_drive", name: "COFFEE DRIVE", coords: [47.060133, 28.874532] },
  { id: "coffee_stop", name: "Coffee Stop", coords: [47.066017, 28.856687] },
  { id: "black_coffee_drive", name: "Black Coffee Drive", coords: [47.046993, 28.779928] },
  { id: "flamingo_coffee", name: "Flamingo Coffee", coords: [47.061938, 28.848433] },
  { id: "grand_coffee_place", name: "Grand Coffee Place", coords: [47.001321, 28.871157] }
];

/* ---------------------------
   DEVICE ID
---------------------------- */

function getDeviceId() {
  let id = localStorage.getItem("beanly_id");
  if (!id) {
    id = "dev_" + Math.random().toString(36).substring(2);
    localStorage.setItem("beanly_id", id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();

/* ---------------------------
   RATING STATE
---------------------------- */

let globalRatings = {};
let currentCafe = null;
let currentRating = null;

/* ---------------------------
   LOAD RATINGS FROM SUPABASE
---------------------------- */

async function loadRatings() {
  const { data, error } = await sb.from("ratings").select("cafe_id, rating");

  const agg = {};
  (data || []).forEach(r => {
    if (!agg[r.cafe_id]) agg[r.cafe_id] = { sum: 0, count: 0 };
    agg[r.cafe_id].sum += r.rating;
    agg[r.cafe_id].count++;
  });

  globalRatings = {};
  Object.keys(agg).forEach(id => {
    globalRatings[id] = {
      avg: agg[id].sum / agg[id].count,
      votes: agg[id].count
    };
  });

  buildLeaderboard();
}

/* ---------------------------
   LEADERBOARD
---------------------------- */

function buildLeaderboard() {
  const box = document.getElementById("leaderboard");

  const rated = cafes
    .map(c => ({ ...c, info: globalRatings[c.id] }))
    .filter(c => c.info)
    .sort((a, b) => b.info.avg - a.info.avg)
    .slice(0, 5);

  if (!rated.length) {
    box.innerHTML = `<h4>Top ☕</h4><div>Nu există ratinguri încă.</div>`;
    return;
  }

  let html = `<h4>Top ☕</h4><ul>`;
  rated.forEach(c => {
    html += `
      <li data-id="${c.id}">
        <span class="name">${c.name}</span><br>
        <span class="stats">${c.info.avg.toFixed(1)} ⭐ · (${c.info.votes})</span>
      </li>
    `;
  });
  html += "</ul>";

  box.innerHTML = html;

  box.querySelectorAll("li").forEach(li => {
    li.onclick = () => {
      const cafe = cafes.find(c => c.id === li.dataset.id);
      map.setView(cafe.coords, 15);
      markers[cafe.id].openPopup();
    };
  });
}

/* ---------------------------
   SEND RATING
---------------------------- */

async function sendRating(id, rating) {
  await sb.from("ratings").insert({
    cafe_id: id,
    device_id: DEVICE_ID,
    rating
  });
}

/* ---------------------------
   INIT MAP
---------------------------- */

let map;
const markers = {};

document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram?.WebApp;
  tg && tg.expand();

  await loadRatings();

  map = L.map("map").setView([47.040, 28.85], 12.5);

  /* ---------------------------
     MAPTILER WAZE-LIKE STYLE
  ---------------------------- */

    L.tileLayer(
  `https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
  {
    maxZoom: 19,
    tileSize: 512,
    zoomOffset: -1,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ' +
      'contributors & <a href="https://www.maptiler.com/">MapTiler</a>'
  }
).addTo(map);



  /* ---------------------------
     MARKERS
  ---------------------------- */

  cafes.forEach(cafe => {
    const marker = L.marker(cafe.coords).addTo(map);

    marker.bindPopup(`
      <b>${cafe.name}</b><br>
      Rating: ${
        globalRatings[cafe.id]
          ? globalRatings[cafe.id].avg.toFixed(1) + " ⭐ (" + globalRatings[cafe.id].votes + ")"
          : "Nu are rating"
      }<br><br>
      <button onclick="openModal('${cafe.id}')">Lasă rating</button>
    `);

    markers[cafe.id] = marker;
  });
});

/* ---------------------------
   MODAL
---------------------------- */

window.openModal = function (cafeId) {
  currentCafe = cafeId;
  document.getElementById("rating-cafe-name").innerText =
    cafes.find(c => c.id === cafeId).name;

  document.getElementById("rating-modal-backdrop").style.display = "flex";
};

document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("rating-modal-backdrop").style.display = "none";
};

document.querySelectorAll(".star").forEach(star => {
  star.onclick = () => {
    currentRating = parseInt(star.dataset.val);
    document.querySelectorAll(".star").forEach(s =>
      s.classList.toggle("active", parseInt(s.dataset.val) <= currentRating)
    );
  };
});

document.getElementById("sendBtn").onclick = async () => {
  if (!currentRating) {
    alert("Alege numărul de stele!");
    return;
  }

  await sendRating(currentCafe, currentRating);
  alert("Mulțumim!");

  document.getElementById("rating-modal-backdrop").style.display = "none";
  location.reload();
};
</script>

</body>
</html>
