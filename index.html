<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Beanly Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* Leaderboard mic */
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 900;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 170px;
      font-size: 11px;
      line-height: 1.3;
    }

    #leaderboard h4 {
      margin: 0 0 4px;
      font-size: 12px;
    }

    #leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #leaderboard li {
      margin-bottom: 4px;
      cursor: pointer;
    }

    #leaderboard li span.name {
      font-weight: 600;
    }

    #leaderboard li span.stats {
      color: #555;
      font-size: 11px;
    }

    /* Buton schimbare temƒÉ (zi/noapte) */
    #theme-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 950;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: rgba(255,255,255,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(15,23,42,0.25);
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }

    /* Buton "loca»õia mea" */
    #locate-btn {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 950;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(255,255,255,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(15,23,42,0.25);
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }

    /* Zoom buttons: ascunse pe telefon, vizibile pe desktop */
    @media (max-width: 768px) {
      .leaflet-control-zoom {
        display: none;
      }
    }

    /* Modal rating */
    #rating-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    #rating-modal {
      width: 280px;
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    #rating-modal h3 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    #rating-modal p {
      margin: 0 0 10px;
      font-size: 14px;
    }

    #rating-stars {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 8px;
    }

    .star {
      font-size: 26px;
      cursor: pointer;
      color: #bbb;
      user-select: none;
    }

    .star.active {
      color: #f5b301;
    }

    .leaflet-tile {
      image-rendering: auto;
    }

    /* Marker Beanly custom */
    .beanly-marker {
      background: none;
      border: none;
    }

    .beanly-marker-inner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #ffbf69;              /* portocaliu cald */
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #4b2e16;                   /* culoare ‚Äûcafea‚Äù */
      position: relative;
    }

    .beanly-marker-inner::after {
      content: "";
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #ffbf69;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
    }
  </style>
</head>

<body>

<div id="map"></div>
<div id="leaderboard"></div>
<div id="theme-toggle" title="SchimbƒÉ tema">üåô</div>
<div id="locate-btn" title="Loca»õia mea">üìç</div>

<!-- Rating modal -->
<div id="rating-modal-backdrop">
  <div id="rating-modal">
    <h3>LasƒÉ un rating</h3>
    <p id="rating-cafe-name"></p>

    <div id="rating-stars">
      <span class="star" data-val="1">‚òÖ</span>
      <span class="star" data-val="2">‚òÖ</span>
      <span class="star" data-val="3">‚òÖ</span>
      <span class="star" data-val="4">‚òÖ</span>
      <span class="star" data-val="5">‚òÖ</span>
    </div>

    <div style="padding-top: 10px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="cancelBtn">AnuleazƒÉ</button>
      <button id="sendBtn">Trimite</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------------------
   CONFIG
---------------------------- */

const MAPTILER_KEY = "K2TXKYl91HXvMVDhjRcy";

const SUPABASE_URL = "https://fmjzvkjirengslympwyy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Huzv6C0t7gw4UFgb_7Za0A_Ptj6hwu_";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------------------
   CAFENELE
---------------------------- */

const cafes = [
  { id: "coffee_drive",       name: "COFFEE DRIVE",       coords: [47.060133, 28.874532] },
  { id: "coffee_stop",        name: "Coffee Stop",        coords: [47.066017, 28.856687] },
  { id: "black_coffee_drive", name: "Black Coffee Drive", coords: [47.046993, 28.779928] },
  { id: "flamingo_coffee",    name: "Flamingo Coffee",    coords: [47.061938, 28.848433] },
  { id: "grand_coffee_place", name: "Grand Coffee Place", coords: [47.001321, 28.871157] }
];

/* ---------------------------
   DEVICE ID
---------------------------- */

function getDeviceId() {
  let id = localStorage.getItem("beanly_id");
  if (!id) {
    id = "dev_" + Math.random().toString(36).substring(2);
    localStorage.setItem("beanly_id", id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();

/* ---------------------------
   RATING STATE
---------------------------- */

let globalRatings = {};
let currentCafe = null;
let currentRating = null;

/* ---------------------------
   THEME (DAY / NIGHT)
---------------------------- */

const THEME_KEY = "beanly_theme";

function getInitialTheme() {
  const saved = localStorage.getItem(THEME_KEY);
  if (saved === "day" || saved === "night") return saved;

  const hour = new Date().getHours();
  if (hour >= 20 || hour < 7) return "night";
  return "day";
}

let currentTheme = getInitialTheme();

/* ---------------------------
   LOAD RATINGS FROM SUPABASE
---------------------------- */

async function loadRatings() {
  const { data, error } = await sb.from("ratings").select("cafe_id, rating");

  const agg = {};
  (data || []).forEach(r => {
    if (!agg[r.cafe_id]) agg[r.cafe_id] = { sum: 0, count: 0 };
    agg[r.cafe_id].sum += r.rating;
    agg[r.cafe_id].count++;
  });

  globalRatings = {};
  Object.keys(agg).forEach(id => {
    globalRatings[id] = {
      avg: agg[id].sum / agg[id].count,
      votes: agg[id].count
    };
  });

  buildLeaderboard();
}

/* ---------------------------
   LEADERBOARD
---------------------------- */

function buildLeaderboard() {
  const box = document.getElementById("leaderboard");

  const rated = cafes
    .map(c => ({ ...c, info: globalRatings[c.id] }))
    .filter(c => c.info)
    .sort((a, b) => b.info.avg - a.info.avg)
    .slice(0, 5);

  if (!rated.length) {
    box.innerHTML = `<h4>Top ‚òï</h4><div>Nu existƒÉ ratinguri √ÆncƒÉ.</div>`;
    return;
  }

  let html = `<h4>Top ‚òï</h4><ul>`;
  rated.forEach(c => {
    html += `
      <li data-id="${c.id}">
        <span class="name">${c.name}</span><br>
        <span class="stats">${c.info.avg.toFixed(1)} ‚≠ê ¬∑ (${c.info.votes})</span>
      </li>
    `;
  });
  html += "</ul>";

  box.innerHTML = html;

  box.querySelectorAll("li").forEach(li => {
    li.onclick = () => {
      const cafe = cafes.find(c => c.id === li.dataset.id);
      if (!cafe || !map) return;
      map.setView(cafe.coords, 15);
      if (markers[cafe.id]) {
        markers[cafe.id].openPopup();
      }
    };
  });
}

/* ---------------------------
   SEND RATING
---------------------------- */

async function sendRating(id, rating) {
  await sb.from("ratings").insert({
    cafe_id: id,
    device_id: DEVICE_ID,
    rating
  });
}

/* ---------------------------
   MAP & MARKERS
---------------------------- */

let map;
const markers = {};
let dayLayer, nightLayer;
let userMarker = null;

// Marker Beanly personalizat (divIcon)
const beanlyIcon = L.divIcon({
  className: "beanly-marker",
  html: '<div class="beanly-marker-inner">‚òï</div>',
  iconSize: [34, 40],
  iconAnchor: [17, 40]
});

function applyTheme() {
  const toggle = document.getElementById("theme-toggle");
  if (!map || !dayLayer || !nightLayer || !toggle) return;

  if (currentTheme === "night") {
    if (map.hasLayer(dayLayer)) map.removeLayer(dayLayer);
    if (!map.hasLayer(nightLayer)) map.addLayer(nightLayer);
    toggle.textContent = "‚òÄÔ∏è";
  } else {
    if (map.hasLayer(nightLayer)) map.removeLayer(nightLayer);
    if (!map.hasLayer(dayLayer)) map.addLayer(dayLayer);
    toggle.textContent = "üåô";
  }
}

/* ---------------------------
   GEOLOCATION
---------------------------- */

function locateUser() {
  if (!navigator.geolocation) {
    alert("Acest dispozitiv nu suportƒÉ geolocalizare.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const latlng = [lat, lng];

      if (!map) return;

      if (!userMarker) {
        userMarker = L.circleMarker(latlng, {
          radius: 8,
          color: "#2563eb",
          fillColor: "#3b82f6",
          fillOpacity: 0.9
        }).addTo(map);
      } else {
        userMarker.setLatLng(latlng);
      }

      map.setView(latlng, 15);
    },
    (err) => {
      let msg = "Nu am putut ob»õine loca»õia.";
      if (err.code === err.PERMISSION_DENIED) {
        msg = "Nu ai permis accesul la loca»õie.";
      }
      alert(msg);
    },
    {
      enableHighAccuracy: true,
      timeout: 10000
    }
  );
}

/* ---------------------------
   INIT
---------------------------- */

document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  await loadRatings();

  map = L.map('map', {
    center: [47.040, 28.85],
    zoom: 12.5,

    // zoom mai agresiv pe PC
    zoomSnap: 0.5,
    zoomDelta: 1,
    scrollWheelZoom: true,
    wheelDebounceTime: 20,
    wheelPxPerZoomLevel: 20,

    zoomAnimation: true,
    markerZoomAnimation: true,

    // limitare zoom-out
    minZoom: 3.2,

    // limitƒÉm lumea la un singur glob, fƒÉrƒÉ dubluri
    maxBounds: [
      [85, -180],
      [-85, 180]
    ],
    maxBoundsViscosity: 1.0,
    worldCopyJump: false
  });

  // LAYER DAY (streets-v4)
  dayLayer = L.tileLayer(
    `https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
    {
      maxZoom: 19,
      tileSize: 512,
      zoomOffset: -1,
      detectRetina: true,
      noWrap: true,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ' +
        'contributors & <a href="https://www.maptiler.com/">MapTiler</a>'
    }
  );

  // LAYER NIGHT (dark style)
  nightLayer = L.tileLayer(
    `https://api.maptiler.com/maps/streets-v2-dark/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
    {
      maxZoom: 19,
      tileSize: 512,
      zoomOffset: -1,
      detectRetina: true,
      noWrap: true,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ' +
        'contributors & <a href="https://www.maptiler.com/">MapTiler</a>'
    }
  );

  // aplicƒÉm tema ini»õialƒÉ
  applyTheme();

  // buton toggle zi/noapte
  const toggle = document.getElementById("theme-toggle");
  if (toggle) {
    toggle.addEventListener("click", () => {
      currentTheme = currentTheme === "night" ? "day" : "night";
      localStorage.setItem(THEME_KEY, currentTheme);
      applyTheme();
    });
  }

  // buton "loca»õia mea"
  const locateBtn = document.getElementById("locate-btn");
  if (locateBtn) {
    locateBtn.addEventListener("click", locateUser);
  }

  /* ---------------------------
     MARKERS
  ---------------------------- */

  cafes.forEach(cafe => {
    const marker = L.marker(cafe.coords, { icon: beanlyIcon }).addTo(map);

    marker.bindPopup(`
      <b>${cafe.name}</b><br>
      Rating: ${
        globalRatings[cafe.id]
          ? globalRatings[cafe.id].avg.toFixed(1) + " ‚≠ê (" + globalRatings[cafe.id].votes + ")"
          : "Nu are rating"
      }<br><br>
      <button onclick="openModal('${cafe.id}')">LasƒÉ rating</button>
    `);

    markers[cafe.id] = marker;
  });
});

/* ---------------------------
   MODAL
---------------------------- */

window.openModal = function (cafeId) {
  currentCafe = cafeId;
  const cafe = cafes.find(c => c.id === cafeId);
  document.getElementById("rating-cafe-name").innerText = cafe ? cafe.name : "";

  document.getElementById("rating-modal-backdrop").style.display = "flex";
};

document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("rating-modal-backdrop").style.display = "none";
  currentRating = null;
  document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));
};

document.querySelectorAll(".star").forEach(star => {
  star.onclick = () => {
    currentRating = parseInt(star.dataset.val);
    document.querySelectorAll(".star").forEach(s =>
      s.classList.toggle("active", parseInt(s.dataset.val) <= currentRating)
    );
  };
});

document.getElementById("sendBtn").onclick = async () => {
  if (!currentRating) {
    alert("Alege numƒÉrul de stele!");
    return;
  }

  try {
    await sendRating(currentCafe, currentRating);
    alert("Mul»õumim!");

    document.getElementById("rating-modal-backdrop").style.display = "none";
    currentRating = null;
    document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));

    // Re√ÆncarcƒÉm pagina ca sƒÉ se actualizeze ratingurile »ôi leaderboard-ul
    location.reload();
  } catch (e) {
    console.error(e);
    alert("A apƒÉrut o eroare la trimiterea ratingului.");
  }
};
</script>

</body>
</html>
