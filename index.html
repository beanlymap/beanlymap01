<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Beanly Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
}
#map { width: 100%; height: 100vh; }
#scanner {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 300px;
    display: none;
    z-index: 1000;
    border: 2px solid #000;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="scanner"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- HTML5 QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // =======================
    // Telegram Web App setup
    // =======================
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand();
        tg.MainButton.setParams({ text: "ðŸ“· ScaneazÄƒ QR", color: "#000000" });
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            startScan();
        });
    }

    // =======================
    // Initialize Leaflet map
    // =======================
    const map = L.map('map').setView([47.010, 28.835], 13);

    // Tile layer modern gratuit (Carto Light)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // =======================
    // Markers for cafes
    // =======================
    const cafes = [
    { id: "coffee_vibe", name: "Coffee Vibe", coords: [47.0246, 28.8325] },
    { id: "tucano_center", name: "Tucano Coffee (Centru)", coords: [47.0240, 28.8365] },
    { id: "coffee_house", name: "Coffee House", coords: [47.0218, 28.8371] },
    { id: "arte_cafe", name: "Arte CafÃ©", coords: [47.0188, 28.8353] },
    { id: "creme_de_la_creme", name: "CrÃ¨me de la CrÃ¨me", coords: [47.0147, 28.8316] }
];

function getRating(cafeId) {
    const data = localStorage.getItem(cafeId);
    if (!data) return { total: 0, votes: 0 };
    return JSON.parse(data);
}

function saveRating(cafeId, rating) {
    const data = getRating(cafeId);
    data.total += rating;
    data.votes += 1;
    localStorage.setItem(cafeId, JSON.stringify(data));
}

function getAverage(cafeId) {
    const data = getRating(cafeId);
    if (data.votes === 0) return "Nu are rating";
    return (data.total / data.votes).toFixed(1) + " â­";
}

    cafes.forEach(cafe => {
    const avg = getAverage(cafe.id);

    const marker = L.marker(cafe.coords).addTo(map)
        .bindPopup(`
            <b>${cafe.name}</b><br>
            Rating: ${avg}<br><br>
            <button onclick="rateCafe('${cafe.id}', '${cafe.name}')">
                LasÄƒ un rating
            </button>
        `);
});
function rateCafe(cafeId, cafeName) {
    let rating = prompt(`DÄƒ un rating pentru ${cafeName} (1-10):`);
    rating = parseInt(rating);

    if (!isNaN(rating) && rating >= 1 && rating <= 10) {
        saveRating(cafeId, rating);
        alert("âœ… MulÈ›umim pentru vot!");
        location.reload(); // reÃ®ncarcÄƒ harta ca sÄƒ vezi ratingul actualizat
    } else {
        alert("âŒ Rating invalid. Introdu un numÄƒr Ã®ntre 1 È™i 10.");
    }
}


    // =======================
    // QR Scanner function
    // =======================
    function startScan() {
        const scannerDiv = document.getElementById("scanner");
        scannerDiv.style.display = "block";

        const qrScanner = new Html5Qrcode("scanner");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                qrScanner.stop();
                scannerDiv.style.display = "none";
                handleRating(decodedText);
            },
            (errorMessage) => {
                // erori ignorate
            }
        );
    }

    // =======================
    // Rating function
    // =======================
    function handleRating(cafeName) {
        let rating = prompt(`Ai scanat QR pentru ${cafeName}. LasÄƒ un rating de la 1 la 10:`);
        rating = parseInt(rating);
        if (!isNaN(rating) && rating >= 1 && rating <= 10) {
            alert(`MulÈ›umim! Ai dat ${rating} stele pentru ${cafeName}`);
        } else {
            alert("Rating invalid. Te rog introdu un numÄƒr de la 1 la 10.");
        }
    }

});
</script>

</body>
</html>
 