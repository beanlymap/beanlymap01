<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Beanly Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* Modal rating */
    #rating-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1100;
      justify-content: center;
      align-items: center;
    }

    #rating-modal {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 280px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    #rating-modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    #rating-modal p {
      margin: 4px 0 10px;
      font-size: 14px;
    }

    /* Stele */
    #rating-stars {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
      justify-content: center;
    }

    .star {
      font-size: 24px;
      color: #cccccc;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease, color 0.1s ease;
    }

    .star.active {
      color: #f5b301;
      transform: scale(1.05);
    }

    #rating-emoji {
      text-align: center;
      font-size: 22px;
      margin-bottom: 10px;
      min-height: 26px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    button {
      cursor: pointer;
    }

    .btn-primary {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #000;
      color: #fff;
      font-size: 14px;
    }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      background: #f5f5f5;
      font-size: 14px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }

    .popup button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #000;
      color: #fff;
      font-size: 13px;
    }

    .popup button[disabled] {
      opacity: 0.5;
      cursor: default;
      background: #444;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Modal rating -->
<div id="rating-modal-backdrop">
  <div id="rating-modal">
    <h3 id="rating-title">LasƒÉ un rating</h3>
    <p id="rating-subtitle"></p>

    <!-- stele 1‚Äì5 -->
    <div id="rating-stars">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
    </div>

    <!-- emoji asociat ratingului -->
    <div id="rating-emoji"></div>

    <div class="modal-actions">
      <button id="rating-cancel" class="btn-secondary">AnuleazƒÉ</button>
      <button id="rating-submit" class="btn-primary">Trimite</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // =======================
  // Date cafenele reale
  // =======================
  const cafes = [
    { id: "coffee_drive",        name: "COFFEE DRIVE",        coords: [47.060133, 28.874532] },
    { id: "coffee_stop",         name: "Coffee Stop",         coords: [47.066017, 28.856687] },
    { id: "black_coffee_drive",  name: "Black Coffee Drive",  coords: [47.046993, 28.779928] },
    { id: "flamingo_coffee",     name: "Flamingo Coffee",     coords: [47.061938, 28.848433] },
    { id: "grand_coffee_place",  name: "Grand Coffee Place",  coords: [47.001321, 28.871157] }
  ];

  // Emoji pentru rating 1‚Äì5
  const ratingEmojis = {
    1: "üò£",
    2: "üòï",
    3: "üòê",
    4: "üôÇ",
    5: "ü§©"
  };

  // =======================
  // Rating local: 1 vot per device per cafenea
  // =======================

  // structura: { [cafeId]: rating }
  function getUserRatingsMap() {
    const raw = localStorage.getItem("beanly_user_ratings");
    if (!raw) return {};
    try {
      return JSON.parse(raw);
    } catch {
      return {};
    }
  }

  function getUserRating(cafeId) {
    const map = getUserRatingsMap();
    return typeof map[cafeId] === "number" ? map[cafeId] : null;
  }

  function hasUserRated(cafeId) {
    return getUserRating(cafeId) !== null;
  }

  // structura agregatƒÉ: { total, votes } pentru fiecare cafenea, pe acest device
  function getRatingAgg(cafeId) {
    const raw = localStorage.getItem("agg_" + cafeId);
    if (!raw) return { total: 0, votes: 0 };
    try {
      return JSON.parse(raw);
    } catch {
      return { total: 0, votes: 0 };
    }
  }

  function saveRatingAgg(cafeId, rating) {
    const agg = getRatingAgg(cafeId);
    agg.total += rating;
    agg.votes += 1;
    localStorage.setItem("agg_" + cafeId, JSON.stringify(agg));
  }

  // √énregistrƒÉm ratingul userului: doar dacƒÉ NU a votat √Ænainte
  function registerUserRating(cafeId, rating) {
    const map = getUserRatingsMap();
    if (typeof map[cafeId] === "number") {
      return false; // deja a votat
    }
    map[cafeId] = rating;
    localStorage.setItem("beanly_user_ratings", JSON.stringify(map));
    saveRatingAgg(cafeId, rating);
    return true;
  }

  function getAverageText(cafeId) {
    const agg = getRatingAgg(cafeId);
    if (!agg || agg.votes === 0) return "Nu are rating";
    const avg = (agg.total / agg.votes).toFixed(1);
    return `${avg} ‚≠ê (${agg.votes} voturi pe acest dispozitiv)`;
  }

  // =======================
  // Modal rating (cu 5 stele + emoji)
  // =======================
  let currentCafeId = null;
  let currentCafeName = null;
  let currentRating = null;

  const modalBackdrop  = document.getElementById("rating-modal-backdrop");
  const ratingTitle    = document.getElementById("rating-title");
  const ratingSubtitle = document.getElementById("rating-subtitle");
  const btnCancel      = document.getElementById("rating-cancel");
  const btnSubmit      = document.getElementById("rating-submit");
  const starElems      = document.querySelectorAll("#rating-stars .star");
  const emojiElem      = document.getElementById("rating-emoji");

  function resetStars() {
    currentRating = null;
    starElems.forEach(s => s.classList.remove("active"));
    emojiElem.textContent = "";
  }

  function updateEmoji() {
    if (!currentRating) {
      emojiElem.textContent = "";
      return;
    }
    emojiElem.textContent = ratingEmojis[currentRating] || "";
  }

  function openRatingModal(cafeId, cafeName) {
    // dacƒÉ userul a votat deja, nu mai deschidem modal
    if (hasUserRated(cafeId)) {
      const r = getUserRating(cafeId);
      alert(`Ai votat deja ${cafeName} cu ${r} ‚≠ê de pe acest telefon.`);
      return;
    }

    currentCafeId = cafeId;
    currentCafeName = cafeName;
    ratingTitle.textContent = "LasƒÉ un rating";
    ratingSubtitle.textContent = cafeName;
    resetStars();
    modalBackdrop.style.display = "flex";
  }

  function closeRatingModal() {
    modalBackdrop.style.display = "none";
    currentCafeId = null;
    currentCafeName = null;
    currentRating = null;
  }

  // click pe stele
  starElems.forEach(star => {
    star.addEventListener("click", () => {
      const val = parseInt(star.getAttribute("data-value"), 10);
      currentRating = val;
      starElems.forEach(s => {
        const sVal = parseInt(s.getAttribute("data-value"), 10);
        s.classList.toggle("active", sVal <= val);
      });
      updateEmoji();
    });
  });

  btnCancel.addEventListener("click", closeRatingModal);

  btnSubmit.addEventListener("click", () => {
    if (!currentCafeId) return;

    if (!currentRating || currentRating < 1 || currentRating > 5) {
      alert("Alege un numƒÉr de stele (1‚Äì5).");
      return;
    }

    const ok = registerUserRating(currentCafeId, currentRating);
    if (!ok) {
      const r = getUserRating(currentCafeId);
      alert(`Ai votat deja ${currentCafeName} cu ${r} ‚≠ê de pe acest telefon.`);
      closeRatingModal();
      return;
    }

    alert(`‚úÖ Mul»õumim! Ai dat ${currentRating} stele pentru ${currentCafeName}.`);
    closeRatingModal();
    location.reload(); // re√ÆmprospƒÉtƒÉm, pentru a vedea media actualizatƒÉ √Æn popup
  });

  // =======================
  // Init
  // =======================
  document.addEventListener("DOMContentLoaded", function() {
    // Telegram Web App setup
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      // ascundem MainButton, nu mai folosim QR
      tg.MainButton.hide();
    }

    // Harta
    const map = L.map('map').setView([47.040, 28.85], 12.5);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // Markere cafenele
    cafes.forEach(cafe => {
      const avgText = getAverageText(cafe.id);
      const userRating = getUserRating(cafe.id);
      const buttonLabel = userRating ? `Ai votat: ${userRating} ‚≠ê` : "LasƒÉ un rating";
      const buttonDisabled = userRating ? 'disabled="disabled"' : "";

      const marker = L.marker(cafe.coords).addTo(map)
        .bindPopup(`
          <div class="popup">
            <b>${cafe.name}</b><br>
            Rating: ${avgText}<br><br>
            <button class="rate-btn" data-id="${cafe.id}" data-name="${cafe.name}" ${buttonDisabled}>
              ${buttonLabel}
            </button>
          </div>
        `);

      marker.on('popupopen', (e) => {
        const btn = e.popup._contentNode.querySelector('.rate-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute("data-id");
            const name = btn.getAttribute("data-name");
            openRatingModal(id, name);
          });
        }
      });
    });
  });
</script>

</body>
</html>
