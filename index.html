<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Beanly Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
}
#map { width: 100%; height: 100vh; }
#scanner {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 300px;
    display: none;
    z-index: 1000;
    border: 2px solid #000;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="scanner"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- HTML5 QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // =======================
    // Telegram Web App setup
    // =======================
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand();
        tg.MainButton.setParams({ text: "ðŸ“· ScaneazÄƒ QR", color: "#000000" });
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            startScan();
        });
    }

    // =======================
    // Initialize Leaflet map
    // =======================
    const map = L.map('map').setView([47.010, 28.835], 13);

    // Tile layer modern gratuit (Carto Light)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // =======================
    // Markers for cafes
    // =======================
    const cafes = [
        { name: "Cafea Central", coords: [47.010, 28.835] },
        { name: "Cafea Verde", coords: [47.012, 28.840] },
        { name: "Cafea Latte", coords: [47.005, 28.830] }
    ];

    cafes.forEach(cafe => {
        L.marker(cafe.coords).addTo(map)
            .bindPopup(cafe.name);
    });

    // =======================
    // QR Scanner function
    // =======================
    function startScan() {
        const scannerDiv = document.getElementById("scanner");
        scannerDiv.style.display = "block";

        const qrScanner = new Html5Qrcode("scanner");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                qrScanner.stop();
                scannerDiv.style.display = "none";
                handleRating(decodedText);
            },
            (errorMessage) => {
                // erori ignorate
            }
        );
    }

    // =======================
    // Rating function
    // =======================
    function handleRating(cafeName) {
        let rating = prompt(`Ai scanat QR pentru ${cafeName}. LasÄƒ un rating de la 1 la 10:`);
        rating = parseInt(rating);
        if (!isNaN(rating) && rating >= 1 && rating <= 10) {
            alert(`MulÈ›umim! Ai dat ${rating} stele pentru ${cafeName}`);
        } else {
            alert("Rating invalid. Te rog introdu un numÄƒr de la 1 la 10.");
        }
    }

});
</script>

</body>
</html>
