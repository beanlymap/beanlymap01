<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Beanly Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #scanner {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 300px;
      display: none;
      z-index: 1000;
      border: 2px solid #000;
      background: #000;
    }

    /* Modal rating */
    #rating-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1100;
      justify-content: center;
      align-items: center;
    }

    #rating-modal {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 280px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    #rating-modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    #rating-modal p {
      margin: 4px 0 10px;
      font-size: 14px;
    }

    /* Stele */
    #rating-stars {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 10px;
    }

    .star {
      font-size: 22px;
      color: #cccccc;
      cursor: pointer;
      user-select: none;
    }

    .star.active {
      color: #f5b301;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    button {
      cursor: pointer;
    }

    .btn-primary {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #000;
      color: #fff;
      font-size: 14px;
    }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      background: #f5f5f5;
      font-size: 14px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }

    .popup button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #000;
      color: #fff;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="scanner"></div>

<!-- Modal rating -->
<div id="rating-modal-backdrop">
  <div id="rating-modal">
    <h3 id="rating-title">LasÄƒ un rating</h3>
    <p id="rating-subtitle"></p>

    <!-- stele 1â€“10 -->
    <div id="rating-stars">
      <span class="star" data-value="1">â˜…</span>
      <span class="star" data-value="2">â˜…</span>
      <span class="star" data-value="3">â˜…</span>
      <span class="star" data-value="4">â˜…</span>
      <span class="star" data-value="5">â˜…</span>
      <span class="star" data-value="6">â˜…</span>
      <span class="star" data-value="7">â˜…</span>
      <span class="star" data-value="8">â˜…</span>
      <span class="star" data-value="9">â˜…</span>
      <span class="star" data-value="10">â˜…</span>
    </div>

    <div class="modal-actions">
      <button id="rating-cancel" class="btn-secondary">AnuleazÄƒ</button>
      <button id="rating-submit" class="btn-primary">Trimite</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- HTML5 QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
  // =======================
  // Date cafenele reale
  // =======================
  const cafes = [
    { id: "coffee_drive",        name: "COFFEE DRIVE",        coords: [47.060133, 28.874532] },
    { id: "coffee_stop",         name: "Coffee Stop",          coords: [47.066017, 28.856687] },
    { id: "black_coffee_drive",  name: "Black Coffee Drive",   coords: [47.046993, 28.779928] },
    { id: "flamingo_coffee",     name: "Flamingo Coffee",      coords: [47.061938, 28.848433] },
    { id: "grand_coffee_place",  name: "Grand Coffee Place",   coords: [47.001321, 28.871157] }
  ];

  // =======================
  // Rating storage (localStorage)
  // =======================
  function getRating(cafeId) {
    const data = localStorage.getItem(cafeId);
    if (!data) return { total: 0, votes: 0 };
    return JSON.parse(data);
  }

  function saveRating(cafeId, rating) {
    const data = getRating(cafeId);
    data.total += rating;
    data.votes += 1;
    localStorage.setItem(cafeId, JSON.stringify(data));
  }

  function getAverage(cafeId) {
    const data = getRating(cafeId);
    if (data.votes === 0) return "Nu are rating";
    return (data.total / data.votes).toFixed(1) + " â­";
  }

  // =======================
  // Modal rating (cu stele)
  // =======================
  let currentCafeId = null;
  let currentCafeName = null;
  let currentRating = null;

  const modalBackdrop  = document.getElementById("rating-modal-backdrop");
  const ratingTitle    = document.getElementById("rating-title");
  const ratingSubtitle = document.getElementById("rating-subtitle");
  const btnCancel      = document.getElementById("rating-cancel");
  const btnSubmit      = document.getElementById("rating-submit");
  const starElems      = document.querySelectorAll("#rating-stars .star");

  function resetStars() {
    currentRating = null;
    starElems.forEach(s => s.classList.remove("active"));
  }

  function openRatingModal(cafeId, cafeName) {
    currentCafeId = cafeId;
    currentCafeName = cafeName;
    ratingTitle.textContent = "LasÄƒ un rating";
    ratingSubtitle.textContent = cafeName;
    resetStars();
    modalBackdrop.style.display = "flex";
  }

  function closeRatingModal() {
    modalBackdrop.style.display = "none";
    currentCafeId = null;
    currentCafeName = null;
    currentRating = null;
  }

  // click pe stele
  starElems.forEach(star => {
    star.addEventListener("click", () => {
      const val = parseInt(star.getAttribute("data-value"), 10);
      currentRating = val;
      starElems.forEach(s => {
        const sVal = parseInt(s.getAttribute("data-value"), 10);
        s.classList.toggle("active", sVal <= val);
      });
    });
  });

  btnCancel.addEventListener("click", closeRatingModal);

  btnSubmit.addEventListener("click", () => {
    if (!currentCafeId) return;

    if (!currentRating || currentRating < 1 || currentRating > 10) {
      alert("Alege un numÄƒr de stele (1â€“10).");
      return;
    }

    // aici poÈ›i Ã®nlocui cu fetch() cÄƒtre backend, cÃ¢nd vei avea unul
    saveRating(currentCafeId, currentRating);
    alert(`âœ… MulÈ›umim! Ai dat ${currentRating} stele pentru ${currentCafeName}.`);
    closeRatingModal();
    location.reload(); // reÃ®mprospÄƒtÄƒm popup-urile ca sÄƒ afiÈ™eze media nouÄƒ
  });

  // =======================
  // QR Scanner
  // =======================
  let qrScannerInstance = null;

  function startScan() {
    const scannerDiv = document.getElementById("scanner");
    scannerDiv.style.display = "block";

    if (!qrScannerInstance) {
      qrScannerInstance = new Html5Qrcode("scanner");
    }

    qrScannerInstance.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        qrScannerInstance.stop().then(() => {
          scannerDiv.style.display = "none";
        });
        handleRatingFromQr(decodedText);
      },
      (errorMessage) => {
        // ignorÄƒm erorile minore
      }
    ).catch((err) => {
      console.error("Eroare la pornirea scannerului:", err);
      alert("Nu s-a putut porni camera.");
      scannerDiv.style.display = "none";
    });
  }

  function handleRatingFromQr(decodedText) {
    // ideal: QR-ul conÈ›ine ID-ul cafenelei (ex: "coffee_drive")
    const cafe =
      cafes.find(c => c.id === decodedText) ||
      cafes.find(c => c.name.toLowerCase() === decodedText.toLowerCase());

    if (!cafe) {
      alert("QR necunoscut. VerificÄƒ dacÄƒ codul este corect.");
      return;
    }

    openRatingModal(cafe.id, cafe.name);
  }

  // =======================
  // Init
  // =======================
  document.addEventListener("DOMContentLoaded", function() {
    // Telegram Web App setup
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      tg.MainButton.setParams({
        text: "ðŸ“· ScaneazÄƒ QR",
        color: "#000000"
      });
      tg.MainButton.show();
      tg.MainButton.onClick(startScan);
    }

    // Harta
    const map = L.map('map').setView([47.040, 28.85], 12.5);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // Markere cafenele
    cafes.forEach(cafe => {
      const avg = getAverage(cafe.id);

      const marker = L.marker(cafe.coords).addTo(map)
        .bindPopup(`
          <div class="popup">
            <b>${cafe.name}</b><br>
            Rating: ${avg}<br><br>
            <button class="rate-btn" data-id="${cafe.id}" data-name="${cafe.name}">
              LasÄƒ un rating
            </button>
          </div>
        `);

      marker.on('popupopen', (e) => {
        const btn = e.popup._contentNode.querySelector('.rate-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute("data-id");
            const name = btn.getAttribute("data-name");
            openRatingModal(id, name);
          });
        }
      });
    });
  });
</script>

</body>
</html>
